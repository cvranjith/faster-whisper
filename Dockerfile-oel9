FROM container-registry.oracle.com/os/oraclelinux:9

RUN set -eux && \
    dnf -y update && \
    dnf -y install oracle-epel-release-el9 && \
    dnf config-manager --set-enabled ol9_codeready_builder || true && \
    dnf -y install \
        https://download1.rpmfusion.org/free/el/rpmfusion-free-release-9.noarch.rpm && \
    dnf -y install \
        python3 python3-pip git ffmpeg && \
    dnf clean all && \
    rm -rf /var/cache/{dnf,yum} && \
    python3 -m pip install --no-cache-dir --upgrade pip

WORKDIR /app

COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt && \
    rm -rf /root/.cache && \
    mkdir -p /app/tmp

COPY app/ app/
COPY ssl/ ssl/

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", \
     "--ssl-keyfile", "ssl/key.pem", "--ssl-certfile", "ssl/cert.pem"]